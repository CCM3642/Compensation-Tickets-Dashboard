<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crispy Chicken - Complaints Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heatmapjs@2.0.5/heatmap.min.js"></script>
  <style>
    :root {
      --crispy-red: #d32f2f;
      --crispy-dark: #b71c1c;
      --crispy-light: #ffcdd2;
      --bg-light: #fafafa;
      --text-primary: #333;
      --text-secondary: #666;
      --noon-color: #ffb800;
      --careem-color: #00a86b;
    }

    html, body { height: 100%; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background-color: var(--bg-light); margin:0; color: var(--text-primary); }
    .navbar { background: linear-gradient(135deg, var(--crispy-red), var(--crispy-dark)); box-shadow:0 2px 10px rgba(0,0,0,0.2); }
    .navbar-brand { color:#fff; font-weight:800; display:flex; align-items:center; gap:.5rem; }

    .container-page { max-width: 1280px; margin: 0 auto; padding: 20px; }

    .dashboard-stats { display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:16px; margin-bottom:24px; }
    .stat-card { background:#fff; border-radius:14px; padding:20px; box-shadow:0 4px 14px rgba(0,0,0,.06); border-left:6px solid transparent; }
    .stat-card.total { border-color: var(--crispy-red); }
    .stat-card.open { border-color:#0d6efd; }
    .stat-card.sent { border-color:#f59f00; }
    .stat-card.closed { border-color:#2fb344; }
    .stat-card h3 { margin:4px 0 2px; font-weight:800; }
    .stat-card p { margin:0; color: var(--text-secondary); font-weight:600; }

    .platform-cards { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:16px; margin-bottom:24px; }
    .platform-card { background:#fff; border-radius:16px; padding:22px; box-shadow:0 6px 16px rgba(0,0,0,.08); border:3px solid transparent; text-align:center; }
    .platform-card.noon { border-color: var(--noon-color); }
    .platform-card.careem { border-color: var(--careem-color); }

    .tickets-section { background:#fff; border-radius:18px; padding:22px; box-shadow:0 8px 20px rgba(0,0,0,.08); margin-bottom:28px; }
    .tickets-header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; }

    .table-responsive { border-radius:14px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,.06); }
    thead th { background: var(--crispy-light); color: var(--crispy-dark); font-weight:800; border:none !important; }
    tbody tr:hover { background: rgba(211,47,47,.05); }

    .badge-open { background:#e7f1ff; color:#0d47a1; }
    .badge-sent { background:#fff5db; color:#a15c00; }
    .badge-closed { background:#e6f8ea; color:#1b6b2e; }

    .action-btn { padding:6px 10px; border-radius:8px; border:none; font-weight:700; cursor:pointer; transition:.2s; }
    .btn-edit { background:#ffc107; color:#000; }
    .btn-email { background:#0d6efd; color:#fff; }
    .btn-whatsapp { background:#25D366; color:#fff; }
    .btn-close { background:#28a745; color:#fff; }

    .truncate { max-width: 300px; white-space: nowrap; overflow:hidden; text-overflow:ellipsis; }
    .issue-cell { position: relative; }
    .issue-expand { appearance:none; border:none; background:transparent; text-decoration:underline; cursor:pointer; font-size:.85rem; }

    .action-dock { position:fixed; right:16px; bottom:16px; z-index:1040; display:flex; flex-direction:column; gap:10px; }
    .action-dock .btn { box-shadow:0 8px 24px rgba(0,0,0,.18); font-weight:700; border-radius:999px; padding:12px 16px; }

    textarea.autogrow { overflow:hidden; resize:none; min-height:90px; }

    #heatmapContainer { position:fixed; inset:0; pointer-events:none; z-index:5; display:none; }

    footer { text-align:center; padding:20px; background:var(--crispy-dark); color:#fff; border-radius:18px 18px 0 0; }

    @media(max-width:768px){ .truncate{ max-width:160px; } }
  </style>
</head>
<body>
  <div id="heatmapContainer"></div>

  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-page">
      <a class="navbar-brand" href="#"><i class="bi bi-fire"></i> Crispy Chicken • Complaints</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="#">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="#tickets">Tickets</a></li>
          <li class="nav-item"><a class="nav-link" href="#reports">Reports</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container-page">
    <section class="dashboard-stats">
      <div class="stat-card total"><h3 id="totalTickets">0</h3><p>Total Tickets</p></div>
      <div class="stat-card open"><h3 id="openTickets">0</h3><p>Open Tickets</p></div>
      <div class="stat-card sent"><h3 id="sentTickets">0</h3><p>Sent Tickets</p></div>
      <div class="stat-card closed"><h3 id="closedTickets">0</h3><p>Closed Tickets</p></div>
    </section>

    <section class="platform-cards">
      <div class="platform-card noon">
        <i class="bi bi-cart-check fs-1 d-block mb-2" style="color: var(--noon-color)"></i>
        <h3 id="noonCount">0</h3>
        <p>Noon Orders</p>
        <div id="noonPercentage">0%</div>
      </div>
      <div class="platform-card careem">
        <i class="bi bi-car-front fs-1 d-block mb-2" style="color: var(--careem-color)"></i>
        <h3 id="careemCount">0</h3>
        <p>Careem Orders</p>
        <div id="careemPercentage">0%</div>
      </div>
    </section>

    <section id="reports" class="mb-4">
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="tickets-section">
            <h3 class="h6 fw-bold mb-3"><i class="bi bi-geo-alt"></i> Top Branches</h3>
            <canvas id="branchBar"></canvas>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="tickets-section">
            <h3 class="h6 fw-bold mb-3"><i class="bi bi-exclamation-triangle"></i> Common Issue Types</h3>
            <canvas id="issuePie"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section id="tickets" class="tickets-section">
      <div class="tickets-header">
        <h2 class="h5 m-0"><i class="bi bi-list-task me-1"></i> Complaint Tickets</h2>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-danger" onclick="openAddTicketModal()"><i class="bi bi-plus-circle"></i> Add Ticket</button>
          <button class="btn btn-outline-secondary" onclick="resetData()"><i class="bi bi-arrow-clockwise"></i> Reset</button>
        </div>
      </div>
      <div id="ticketsContainer" class="mt-3"></div>
    </section>
  </main>

  <div class="action-dock">
    <button class="btn btn-danger" onclick="openAddTicketModal()"><i class="bi bi-plus-lg"></i></button>
    <button class="btn btn-outline-dark" onclick="window.print()"><i class="bi bi-printer"></i></button>
    <button class="btn btn-outline-secondary" onclick="toggleHeatmap()"><i class="bi bi-activity"></i></button>
  </div>

  <div class="modal fade" id="addTicketModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header text-white" style="background: linear-gradient(135deg, var(--crispy-red), var(--crispy-dark));">
          <h5 class="modal-title" id="modalTitle">Add Ticket</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addTicketForm">
            <input type="hidden" id="editingId" />
            <div class="row g-3">
              <div class="col-md-6"><label>Order ID</label><input class="form-control" id="orderId" required /></div>
              <div class="col-md-6"><label>Order Date</label><input type="date" class="form-control" id="orderDate" required /></div>
              <div class="col-md-6"><label>Branch</label>
                <select class="form-select" id="branch" required>
                  <option value="">Select Branch</option>
                  <option>Crispy Chicken Khalidiya</option>
                  <option>Crispy Chicken Muroor</option>
                  <option>Crispy Chicken Shabiya 11</option>
                  <option>Crispy Chicken Al Barsha</option>
                  <option>Crispy Chicken Al Satwa</option>
                  <option>Crispy Chicken Electra</option>
                  <option>Crispy Chicken Hamdan</option>
                </select>
              </div>
              <div class="col-md-6"><label>Platform</label>
                <select class="form-select" id="platform" required>
                  <option value="">Select Platform</option>
                  <option>Noon</option>
                  <option>Careem</option>
                </select>
              </div>
              <div class="col-12"><label>Issue</label><textarea class="form-control autogrow" id="issue" required></textarea></div>
              <div class="col-md-6"><label>Compensation (AED)</label><input type="number" min="0" step="0.01" class="form-control" id="compensation" required /></div>
              <div class="col-12"><label>Evidence Link</label><input type="url" class="form-control" id="evidenceLink" placeholder="https://…"/></div>
            </div>
            <button class="btn btn-danger w-100 mt-3">Save Ticket</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <footer>&copy; 2025 Crispy Chicken</footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let tickets = JSON.parse(localStorage.getItem('crispyTickets')) || [];
    let filteredTickets = [...tickets];
    let heatmapVisible=false, heatmapInstance=null, branchChart, issueChart;

    document.addEventListener('DOMContentLoaded',()=>{
      if(tickets.length===0)addSampleData();
      renderTickets(); updateStats(); updatePlatformStats(); renderCharts();
      document.getElementById('addTicketForm').addEventListener('submit', saveTicket);
      initHeatmapLayer();
      document.addEventListener('click',recordInteraction,true);
      document.addEventListener('mousemove', throttle(recordMouseMove,120));
    });

    function addSampleData(){
      tickets=[{id:Date.now(),orderId:'NC123',orderDate:'2025-08-26',branch:'Crispy Chicken Khalidiya',platform:'Noon',issue:'Food was cold',compensation:50,evidence:'None',status:'Open',dateCreated:'2025-08-26'}];
      filteredTickets=[...tickets]; saveToStorage();
    }

    function saveToStorage(){ localStorage.setItem('crispyTickets', JSON.stringify(tickets)); }

    function renderTickets(){
      const container=document.getElementById('ticketsContainer');
      if(filteredTickets.length===0){ container.innerHTML='<div class="text-center p-5 border rounded-3 bg-light">No tickets found</div>'; return; }
      let html='<div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead><tr><th>Order ID</th><th>Branch</th><th>Platform</th><th>Issue</th><th>Evidence</th><th>Status</th><th>Compensation</th><th>Actions</th></tr></thead><tbody>';
      filteredTickets.forEach(t=>{
        const statusClass='badge-'+t.status.toLowerCase();
        const evidence=t.evidence==='None'?'<span class="text-muted">No evidence</span>':'<a href="'+t.evidence+'" target="_blank">link</a>';
        const issueShort=`<span class="truncate">${t.issue}</span> <button class="issue-expand" onclick="openIssueModal(${t.id})">View</button>`;
        html+=`<tr><td>${t.orderId}</td><td>${t.branch}</td><td>${t.platform}</td><td>${issueShort}</td><td>${evidence}</td><td><span class="badge ${statusClass}">${t.status}</span></td><td>${t.compensation}</td><td>
        <button class="action-btn btn-edit" onclick="editTicket(${t.id})"><i class="bi bi-pencil"></i></button>
        <button class="action-btn btn-email" onclick="sendEmail(${t.id})"><i class="bi bi-envelope"></i></button>
        <button class="action-btn btn-whatsapp" onclick="sendWhatsApp(${t.id})"><i class="bi bi-whatsapp"></i></button>
        <button class="action-btn btn-close" onclick="closeTicket(${t.id})"><i class="bi bi-check2-circle"></i></button>
        </td></tr>`;
      });
      html+='</tbody></table></div>'; container.innerHTML=html;
    }

    function updateStats(){ 
      const total=tickets.length; const open=tickets.filter(t=>t.status==='Open').length;
      const sent=tickets.filter(t=>t.status==='Sent').length; const closed=tickets.filter(t=>t.status==='Closed').length;
      document.getElementById('totalTickets').textContent=total;
      document.getElementById('openTickets').textContent=open;
      document.getElementById('sentTickets').textContent=sent;
      document.getElementById('closedTickets').textContent=closed;
    }

    function updatePlatformStats(){ 
      const total=tickets.length||1;
      const noon=tickets.filter(t=>t.platform==='Noon').length;
      const careem=tickets.filter(t=>t.platform==='Careem').length;
      document.getElementById('noonCount').textContent=noon;
      document.getElementById('careemCount').textContent=careem;
      document.getElementById('noonPercentage').textContent=((noon/total)*100).toFixed(1)+'%';
      document.getElementById('careemPercentage').textContent=((careem/total)*100).toFixed(1)+'%';
    }

    function saveTicket(ev){
      ev.preventDefault();
      const data={orderId:document.getElementById('orderId').value, branch:document.getElementById('branch').value, platform:document.getElementById('platform').value, issue:document.getElementById('issue').value, compensation:parseFloat(document.getElementById('compensation').value), evidence:document.getElementById('evidenceLink').value||'None'};
      tickets.unshift({id:Date.now(), status:'Open', dateCreated:new Date().toISOString().split('T')[0], ...data});
      filteredTickets=[...tickets]; saveToStorage(); renderTickets(); updateStats(); updatePlatformStats(); renderCharts();
      bootstrap.Modal.getInstance(document.getElementById('addTicketModal')).hide();
    }

    function editTicket(id){
      const t=tickets.find(x=>x.id===id); if(!t)return;
      document.getElementById('orderId').value=t.orderId;
      document.getElementById('branch').value=t.branch;
      document.getElementById('platform').value=t.platform;
      document.getElementById('issue').value=t.issue;
      document.getElementById('compensation').value=t.compensation;
      document.getElementById('evidenceLink').value=t.evidence==='None'?'':t.evidence;
      document.getElementById('editingId').value=id;
      new bootstrap.Modal(document.getElementById('addTicketModal')).show();
    }

    function closeTicket(id){
      const t=tickets.find(x=>x.id===id); if(!t)return;
      t.status='Closed'; saveToStorage(); renderTickets(); updateStats();
    }

    function sendEmail(id){ const t=tickets.find(x=>x.id===id); if(!t)return; window.open(`mailto:support@crispychicken.ae?subject=Complaint+${t.orderId}&body=Issue:${t.issue}%0D%0ACompensation:${t.compensation}`); }
    function sendWhatsApp(id){ const t=tickets.find(x=>x.id===id); if(!t)return; window.open(`https://wa.me/971500000000?text=OrderID:${t.orderId}%0AIssue:${t.issue}%0ACompensation:${t.compensation}`); }

    function openAddTicketModal(){ document.getElementById('addTicketForm').reset(); document.getElementById('editingId').value=''; new bootstrap.Modal(document.getElementById('addTicketModal')).show(); }
    function resetData(){ if(confirm('Reset all tickets?')){ tickets=[]; filteredTickets=[]; saveToStorage(); renderTickets(); updateStats(); updatePlatformStats(); renderCharts(); } }

    function renderCharts(){
      const branches={}, issues={};
      tickets.forEach(t=>{ branches[t.branch]=(branches[t.branch]||0)+1; issues[t.issue]=(issues[t.issue]||0)+1; });
      const branchLabels=Object.keys(branches); const branchData=Object.values(branches);
      const issueLabels=Object.keys(issues); const issueData=Object.values(issues);
      if(branchChart) branchChart.destroy(); if(issueChart) issueChart.destroy();
      branchChart=new Chart(document.getElementById('branchBar'),{type:'bar',data:{labels:branchLabels,datasets:[{label:'Tickets',data:branchData,backgroundColor:'rgba(211,47,47,0.6)'}]}, options:{responsive:true}});
      issueChart=new Chart(document.getElementById('issuePie'),{type:'pie',data:{labels:issueLabels,datasets:[{data:issueData,backgroundColor:['#d32f2f','#f59f00','#25D366','#0d6efd','#ffc107']}]}, options:{responsive:true}});
    }

    function initHeatmapLayer(){ heatmapInstance=h337.create({container:document.getElementById('heatmapContainer'),radius:40,maxOpacity:.6,minOpacity:0,blur:.9,gradient:{'.4':'blue','.6':'cyan','.8':'yellow','1':'red'}}); }
    function toggleHeatmap(){ heatmapVisible=!heatmapVisible; document.getElementById('heatmapContainer').style.display=heatmapVisible?'block':'none'; }

    function recordInteraction(ev){ if(!heatmapVisible)return; const rect=document.body.getBoundingClientRect(); heatmapInstance.addData({x:ev.clientX, y:ev.clientY, value:1}); }
    let lastMove=0; function throttle(fn,limit){ return function(e){ const now=Date.now(); if(now-lastMove>limit){ lastMove=now; fn(e); }};}
    function recordMouseMove(ev){ recordInteraction(ev); }
  </script>
</body>
</html>
