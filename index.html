<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام متابعة التعويضات - Crispy Chicken</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
    table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1);}
    th, td { padding: 8px 12px; border: 1px solid #ddd; text-align: right; vertical-align: middle; }
    th { background: #ff9800; color: #fff; position: sticky; top: 0; }
    tr:hover { background: #fff3e0; }
    .action-buttons { display: flex; gap: 5px; opacity: 0; transition: opacity 0.3s ease; }
    tr:hover .action-buttons { opacity: 1; }
    button { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; transition: transform 0.2s; }
    button:hover { transform: scale(1.1); }
    .edit { background: #4caf50; color: #fff; }
    .add { background: #2196f3; color: #fff; }
    .whatsapp { background: #25D366; color: #fff; }
    .email { background: #f44336; color: #fff; }
    .close { background: #9e9e9e; color: #fff; }
    input, select { width: 100%; padding: 4px; box-sizing: border-box; }
    .evidence img, .evidence video { max-width: 100px; max-height: 80px; }
    .chart-container { width: 100%; max-width: 800px; margin: 20px auto; background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

<h2>نظام متابعة التعويضات - Crispy Chicken</h2>

<table id="compensationTable">
  <thead>
    <tr>
      <th>Order ID</th>
      <th>Order Date</th>
      <th>Branch</th>
      <th>Platform</th>
      <th>Issue</th>
      <th>Evidence</th>
      <th>Status</th>
      <th>Compensation</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<div class="chart-container">
  <canvas id="compChart"></canvas>
</div>

<script>
  // البيانات الأساسية (يمكن التحديث هنا)
  const initialData = [
    {
      orderId: '127822175', date:'9/2/2025', branch:'Crispy Chicken Hamdan', platform:'Careem',
      issue:'Reason: Wrong item sent Customer Notes: Customer selected reason: I received wrong order/item Customer selected item(s): 1 x Twist Original Sandwiches No cheese as usual, only refund 2aed plz not full sandwich amount',
      evidence:'', status:'Open', compensation:12.99
    },
    {
      orderId: '127822223', date:'9/2/2025', branch:'Crispy Chicken Al Barsha', platform:'Careem',
      issue:'Reason: My Food is not edible (SelfServe) Customer Notes: Customer selected reason: My food was not edible Customer selected item(s): 1 x Twist Original Sandwiches, 1 x Max Double Sandwich Hello! I ordered NOT spicy! You delivered spicy. I can’t eat it',
      evidence:'https://files.fm/u/pk8m5nzdj2', status:'Open', compensation:21.70
    },
    {
      orderId:'127841536', date:'9/2/2025', branch:'Crispy Chicken Hamdan', platform:'Careem',
      issue:'Reason: Missing or unavailable items (Side item) Customer Notes: Customer selected reason: There’s an item missing Customer selected item(s): (no selection made by customer, see comments below) hot cheddar cheese',
      evidence:'https://files.fm/u/pk8m5nzdj2', status:'Open', compensation:6.00
    },
    // أضف باقي البيانات هنا...
  ];

  const tableBody = document.querySelector('#compensationTable tbody');

  // تحميل البيانات من localStorage إذا كانت موجودة
  let tableData = JSON.parse(localStorage.getItem('compData')) || initialData;

  function renderTable() {
    tableBody.innerHTML = '';
    tableData.forEach((row, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.orderId}</td>
        <td>${row.date}</td>
        <td>${row.branch}</td>
        <td>${row.platform}</td>
        <td><input type="text" value="${row.issue}"></td>
        <td class="evidence">
          ${row.evidence ? `<a href="${row.evidence}" target="_blank">عرض</a>` : `<select class="evidenceSelect">
            <option value="">لا يوجد إثبات</option>
            <option value="image">صورة</option>
            <option value="video">فيديو</option>
          </select>`}
        </td>
        <td><select class="statusSelect">
          <option value="Open" ${row.status==='Open'?'selected':''}>Open</option>
          <option value="Closed" ${row.status==='Closed'?'selected':''}>Closed</option>
        </select></td>
        <td><input type="number" value="${row.compensation}" step="0.01"></td>
        <td>
          <div class="action-buttons">
            <button class="edit">Edit</button>
            <button class="whatsapp">WhatsApp</button>
            <button class="email">Email</button>
            <button class="close">Close</button>
          </div>
        </td>
      `;
      tableBody.appendChild(tr);

      // إضافة أحداث الحفظ التلقائي
      tr.querySelector('input[type=text]').addEventListener('change', e=>{
        row.issue = e.target.value;
        saveData();
      });
      tr.querySelector('input[type=number]').addEventListener('change', e=>{
        row.compensation = parseFloat(e.target.value);
        saveData();
        renderChart();
      });
      tr.querySelector('.statusSelect').addEventListener('change', e=>{
        row.status = e.target.value;
        saveData();
      });
      tr.querySelector('.evidenceSelect')?.addEventListener('change', e=>{
        row.evidence = e.target.value;
        saveData();
        renderTable();
      });

      // أزرار وهمية (يمكن ربط WhatsApp/Email لاحقًا)
      tr.querySelector('.edit').addEventListener('click', ()=>alert(`Edit: ${row.orderId}`));
      tr.querySelector('.whatsapp').addEventListener('click', ()=>alert(`Send WhatsApp: ${row.orderId}`));
      tr.querySelector('.email').addEventListener('click', ()=>alert(`Send Email: ${row.orderId}`));
      tr.querySelector('.close').addEventListener('click', ()=>row.status='Closed'||renderTable()||saveData());
    });
  }

  function saveData() {
    localStorage.setItem('compData', JSON.stringify(tableData));
  }

  // رسم بياني للتعويض المالي حسب الفرع
  const ctx = document.getElementById('compChart').getContext('2d');
  let compChart;

  function renderChart() {
    const branchTotals = {};
    tableData.forEach(r=>{
      branchTotals[r.branch] = (branchTotals[r.branch]||0) + r.compensation;
    });
    const labels = Object.keys(branchTotals);
    const data = Object.values(branchTotals);

    if(compChart) compChart.destroy();
    compChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'إجمالي التعويض (AED)',
          data,
          backgroundColor: '#ff9800'
        }]
      },
      options: {
        responsive:true,
        plugins:{legend:{display:false}}
      }
    });
  }

  renderTable();
  renderChart();

</script>

</body>
</html>
