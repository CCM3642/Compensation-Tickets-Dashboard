<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crispy Chicken — Compensation Tickets (Dashboard)</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --crispy-red:#d32f2f;
      --crispy-dark:#b71c1c;
      --bg:#fafafa;
      --muted:#6c757d;
    }
    html,body{height:100%;background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
    .navbar{background:linear-gradient(135deg,var(--crispy-red),var(--crispy-dark));box-shadow:0 2px 10px rgba(0,0,0,.12);}
    .navbar .navbar-brand{color:#fff;font-weight:700}
    .container-page{max-width:1200px;margin:18px auto;padding:0 16px;}
    .card-ghost{background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.06);}

    /* Stats */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:18px;}
    .stat-card{padding:18px;border-radius:12px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.04);border-left:6px solid transparent}
    .stat-card.total{border-color:var(--crispy-red)}
    .platform-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-bottom:18px;}

    /* Tickets */
    .tickets-section{background:#fff;border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.06);margin-bottom:18px}
    .truncate{max-width:360px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;vertical-align:middle}
    .issue-expand{background:none;border:none;color:#0d6efd;text-decoration:underline;cursor:pointer;padding-left:8px}

    /* Dock */
    #dock{position:fixed;right:18px;bottom:18px;z-index:2000;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .dock-toggle{width:52px;height:52px;border-radius:50%;background:var(--crispy-red);color:#fff;border:none;box-shadow:0 8px 26px rgba(0,0,0,.18);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .dock-panel{display:none;flex-direction:column;gap:8px;padding:8px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .dock-panel.show{display:flex}
    .dock-panel button{min-width:170px;font-weight:700;border-radius:10px}

    /* Tooltips small */
    .tip{font-size:.85rem;color:var(--muted)}

    /* Modals & forms tweaks */
    .modal .form-control:focus{box-shadow:0 0 0 .2rem rgba(211,47,47,.12);border-color:var(--crispy-red)}
    textarea.autogrow{resize:none;overflow:hidden;min-height:90px}

    /* Heatmap layer */
    #heatmapContainer{position:fixed;inset:0;pointer-events:none;z-index:50;display:none}

    /* Notifications */
    .notification{position:fixed;top:22px;right:22px;padding:12px 16px;border-radius:10px;color:#fff;z-index:3000;display:none}
    .notification.show{display:block;animation:pop .3s}
    .notification.success{background:#198754}
    .notification.error{background:#dc3545}
    @keyframes pop{from{transform:translateY(-8px);opacity:0}to{transform:none;opacity:1}}

    /* Print: hide controls/dock */
    @media print{
      #dock, .tickets-header .btn, .action-buttons, .navbar, .modal, .notification { display:none !important; }
      body{background:#fff}
    }

    /* responsive */
    @media (max-width: 768px){
      .truncate{max-width:140px}
      .dock-panel button{min-width:140px}
    }
  </style>
</head>
<body>

  <!-- Heatmap container -->
  <div id="heatmapContainer"></div>

  <!-- Nav -->
  <nav class="navbar navbar-expand-lg">
    <div class="container container-page">
      <a class="navbar-brand" href="#"><i class="bi bi-fire me-2" style="font-size:1.4rem"></i> Crispy Chicken — Compensation Tickets</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link text-white" href="#">Dashboard</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container-page">
    <!-- Stats -->
    <section class="stats-grid">
      <div class="stat-card total text-center">
        <div class="text-muted">Total Tickets</div>
        <h2 id="totalTickets">0</h2>
      </div>
      <div class="stat-card text-center">
        <div class="text-muted">Open</div>
        <h2 id="openTickets">0</h2>
      </div>
      <div class="stat-card text-center">
        <div class="text-muted">Sent</div>
        <h2 id="sentTickets">0</h2>
      </div>
      <div class="stat-card text-center">
        <div class="text-muted">Closed</div>
        <h2 id="closedTickets">0</h2>
      </div>
    </section>

    <!-- Platform -->
    <section class="platform-cards">
      <div class="card-ghost text-center">
        <div class="text-muted">Noon Orders</div>
        <h3 id="noonCount">0</h3>
        <div id="noonPercentage">0%</div>
      </div>
      <div class="card-ghost text-center">
        <div class="text-muted">Careem Orders</div>
        <h3 id="careemCount">0</h3>
        <div id="careemPercentage">0%</div>
      </div>
    </section>

    <!-- Reports / Charts -->
    <section id="reports" class="row g-3 mb-3">
      <div class="col-lg-6">
        <div class="card-ghost">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Top Branches by Tickets</strong>
            <small class="text-muted" id="topBranchLabel"></small>
          </div>
          <canvas id="branchChart" height="180"></canvas>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card-ghost">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Issue Types Breakdown</strong>
            <small class="text-muted" id="topIssueLabel"></small>
          </div>
          <canvas id="issueChart" height="180"></canvas>
        </div>
      </div>
    </section>

    <!-- Tickets Section -->
    <section class="tickets-section">
      <div class="tickets-header d-flex justify-content-between align-items-center mb-3">
        <h5 class="m-0">Compensation Tickets</h5>
        <div class="d-flex gap-2 align-items-center">
          <input id="searchInput" class="form-control form-control-sm" style="min-width:220px" placeholder="Search order / branch / issue" />
          <select id="filterBranch" class="form-select form-select-sm" style="min-width:160px">
            <option value="">All Branches</option>
          </select>
          <select id="filterPlatform" class="form-select form-select-sm" style="min-width:120px">
            <option value="">All Platforms</option>
            <option value="Noon">Noon</option>
            <option value="Careem">Careem</option>
          </select>
          <div class="action-buttons d-none d-md-flex">
            <button class="btn btn-primary btn-sm" onclick="openAddModal()"><i class="bi bi-plus-circle me-1"></i> Add</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="addSample()"><i class="bi bi-flask me-1"></i> Sample</button>
          </div>
        </div>
      </div>

      <div id="ticketsContainer"></div>
    </section>
  </main>

  <!-- Add/Edit Modal -->
  <div class="modal fade" id="ticketModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background:linear-gradient(135deg,var(--crispy-red),var(--crispy-dark));color:#fff">
          <h5 class="modal-title" id="modalTitle">Add Compensation Ticket</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="ticketForm">
            <input type="hidden" id="editingId" />
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Order ID</label>
                <input id="f_orderId" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Order Date & Time</label>
                <input id="f_orderDate" type="datetime-local" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Branch</label>
                <select id="f_branch" class="form-select" required>
                  <option value="">Select Branch</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Platform</label>
                <select id="f_platform" class="form-select" required>
                  <option value="">Select Platform</option>
                  <option>Noon</option>
                  <option>Careem</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">Issue Description</label>
                <textarea id="f_issue" class="form-control autogrow" required></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">Compensation (AED)</label>
                <input id="f_compensation" type="number" min="0" step="0.01" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Evidence Link</label>
                <input id="f_evidence" type="url" class="form-control" placeholder="https://... or leave empty">
                <div class="form-check mt-1">
                  <input id="f_noEvidence" type="checkbox" class="form-check-input"><label class="form-check-label">No evidence</label>
                </div>
              </div>
              <div class="col-12 mt-2 d-flex gap-2">
                <button type="submit" class="btn btn-save btn-danger">Save</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Issue Modal -->
  <div class="modal fade" id="issueModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background:linear-gradient(135deg,var(--crispy-red),var(--crispy-dark));color:#fff">
          <h5 class="modal-title">Issue Details</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="issueText" style="white-space:pre-wrap"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <!-- Dock -->
  <div id="dock" title="Drag me">
    <div id="dockPanel" class="dock-panel" role="toolbar" aria-hidden="true">
      <button class="btn btn-danger btn-sm" onclick="openAddModal()" title="New Ticket"><i class="bi bi-plus-circle me-1"></i> New Ticket</button>
      <button class="btn btn-outline-primary btn-sm" onclick="addSample()" title="Add sample tickets"><i class="bi bi-flask me-1"></i> Add Sample</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="resetAll()" title="Reset all data"><i class="bi bi-arrow-clockwise me-1"></i> Reset</button>
      <button class="btn btn-outline-dark btn-sm" onclick="printReport()" title="Print report"><i class="bi bi-printer me-1"></i> Print</button>
      <button class="btn btn-success btn-sm" onclick="exportExcel()" title="Export Excel (XLSX)"><i class="bi bi-file-earmark-spreadsheet me-1"></i> Export Excel</button>
      <button class="btn btn-warning btn-sm" onclick="exportPDF()" title="Export PDF"><i class="bi bi-file-earmark-pdf me-1"></i> Export PDF</button>
      <button class="btn btn-primary btn-sm" onclick="exportDashboardSummary()" title="Dashboard Summary PDF"><i class="bi bi-file-text me-1"></i> Dashboard PDF</button>
      <button id="heatmapToggleBtn" class="btn btn-outline-danger btn-sm" onclick="toggleHeatmap()" title="Toggle Heatmap"><i class="bi bi-activity me-1"></i> Heatmap</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="exportUsabilityLog()" title="Export user interactions"><i class="bi bi-box-arrow-up-right me-1"></i> Export Log</button>
    </div>

    <button id="dockToggle" class="dock-toggle" title="Open actions"><i class="bi bi-gear-fill"></i></button>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heatmapjs@2.0.5/heatmap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
  // ===== State & initial data =====
  let tickets = JSON.parse(localStorage.getItem('crispyTickets')) || [];
  const branchWhats = {
    "Crispy Chicken Khalidiya":"971569494764",
    "Crispy Chicken Muroor":"971505414641",
    "Crispy Chicken Shabiya 11":"971562690688",
    "Crispy Chicken Al Barsha":"971569659524",
    "Crispy Chicken Al Satwa":"971567970685",
    "Crispy Chicken Electra":"971563866859",
    "Crispy Chicken Hamdan":"971556886650",
    "Crispy Chicken-Al Khalidiya":"971569494764"
  };
  const branchesList = Object.keys(branchWhats);

  // ===== DOM refs =====
  const ticketsContainer = document.getElementById('ticketsContainer');
  const searchInput = document.getElementById('searchInput');
  const filterBranch = document.getElementById('filterBranch');
  const filterPlatform = document.getElementById('filterPlatform');
  const notification = document.getElementById('notification');
  const dockToggle = document.getElementById('dockToggle');
  const dockPanel = document.getElementById('dockPanel');
  const dock = document.getElementById('dock');
  const heatmapContainer = document.getElementById('heatmapContainer');

  // Charts
  let branchChart = null, issueChart = null;

  // Heatmap
  let heatmapInstance = null;
  let heatmapVisible = false;
  const interactions = [];

  // Init setup
  document.addEventListener('DOMContentLoaded', () => {
    populateBranchFilters();
    if (tickets.length===0) addSample(); // seed
    renderAll();
    setupListeners();
    initHeatmap();
  });

  // ===== Populate branch selects =====
  function populateBranchFilters(){
    // branch select in filters and modal
    filterBranch.innerHTML = '<option value="">All Branches</option>';
    const fBranch = document.getElementById('f_branch');
    fBranch.innerHTML = '<option value=\"\">Select Branch</option>';
    branchesList.forEach(b=>{
      const opt1 = document.createElement('option'); opt1.value=b; opt1.textContent=b; filterBranch.appendChild(opt1);
      const opt2 = document.createElement('option'); opt2.value=b; opt2.textContent=b; fBranch.appendChild(opt2);
    });
  }

  // ===== Utility =====
  function save() {
    localStorage.setItem('crispyTickets', JSON.stringify(tickets));
  }
  function showNotif(msg, type='success'){
    notification.className = `notification ${type} show`;
    notification.textContent = msg;
    setTimeout(()=>{ notification.className = `notification ${type}`; }, 2800);
  }
  function formatDateISO(dt){
    if(!dt) return '';
    const d = new Date(dt);
    return d.toLocaleString();
  }

  // ===== Render =====
  function renderAll(){
    renderTickets();
    updateStats();
    updatePlatformStats();
    renderCharts();
  }

  function filteredTickets(){
    const q = searchInput.value.trim().toLowerCase();
    const b = filterBranch.value;
    const p = filterPlatform.value;
    return tickets.filter(t=>{
      if(b && t.branch !== b) return false;
      if(p && t.platform !== p) return false;
      if(!q) return true;
      return (t.orderId || '').toString().toLowerCase().includes(q) ||
             (t.branch||'').toLowerCase().includes(q) ||
             (t.issue||'').toLowerCase().includes(q);
    });
  }

  function renderTickets(){
    const data = filteredTickets();
    if(data.length===0){
      ticketsContainer.innerHTML = `<div class="text-center p-4 empty-state"><i class="bi bi-inbox" style="font-size:36px;color:#ddd"></i><h5>No tickets found</h5><p class="text-muted">Add a new compensation ticket to get started</p></div>`;
      return;
    }
    let html = `<div class="table-responsive"><table class="table table-hover align-middle"><thead><tr>
      <th>Order ID</th><th>Order Date</th><th>Branch</th><th>Platform</th><th>Issue</th><th>Evidence</th><th>Status</th><th>Comp</th><th>Actions</th>
    </tr></thead><tbody>`;
    data.forEach(t=>{
      const evidenceHtml = t.evidence && t.evidence!=='None' ? `<a href="${t.evidence}" target="_blank" class="text-primary">link</a>` : `<span class="text-muted">No evidence</span>`;
      const issueShort = `<span class="truncate">${escapeHtml(t.issue)}</span><button class="issue-expand" onclick="openIssueModal('${t.id}')">View</button>`;
      html += `<tr>
        <td><strong>${t.orderId}</strong></td>
        <td>${formatDateISO(t.orderDate)}</td>
        <td>${t.branch}</td>
        <td>${t.platform}</td>
        <td>${issueShort}</td>
        <td>${evidenceHtml}</td>
        <td><span class="badge ${badgeClass(t.status)}">${t.status}</span></td>
        <td>AED ${Number(t.compensation||0).toFixed(2)}</td>
        <td>
          <div class="d-flex flex-wrap gap-1">
            <button class="btn btn-sm btn-outline-primary" title="Edit" onclick="editTicket('${t.id}')"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-info" title="Email" onclick="sendEmail('${t.id}')"><i class="bi bi-envelope"></i></button>
            <button class="btn btn-sm btn-outline-success" title="WhatsApp" onclick="sendWhatsApp('${t.id}')"><i class="bi bi-whatsapp"></i></button>
            <button class="btn btn-sm btn-outline-secondary" title="Copy" onclick="copyTicket('${t.id}')"><i class="bi bi-clipboard"></i></button>
            <button class="btn btn-sm btn-outline-danger" title="Close" onclick="closeTicket('${t.id}')"><i class="bi bi-check2-circle"></i></button>
          </div>
        </td>
      </tr>`;
    });
    html += `</tbody></table></div>`;
    ticketsContainer.innerHTML = html;
  }

  function badgeClass(status){
    if(status==='Open') return 'badge-open';
    if(status==='Sent') return 'badge-sent';
    if(status==='Closed') return 'badge-closed';
    return 'bg-secondary text-white';
  }

  // ===== Stats & Platforms =====
  function updateStats(){
    document.getElementById('totalTickets').textContent = tickets.length;
    document.getElementById('openTickets').textContent = tickets.filter(t=>t.status==='Open').length;
    document.getElementById('sentTickets').textContent = tickets.filter(t=>t.status==='Sent').length;
    document.getElementById('closedTickets').textContent = tickets.filter(t=>t.status==='Closed').length;
  }
  function updatePlatformStats(){
    const total = Math.max(1,tickets.length);
    const noon = tickets.filter(t=>t.platform==='Noon').length;
    const careem = tickets.filter(t=>t.platform==='Careem').length;
    document.getElementById('noonCount').textContent = noon;
    document.getElementById('careemCount').textContent = careem;
    document.getElementById('noonPercentage').textContent = ((noon/total)*100).toFixed(1) + '%';
    document.getElementById('careemPercentage').textContent = ((careem/total)*100).toFixed(1) + '%';
  }

  // ===== Charts =====
  function renderCharts(){
    const byBranch = {};
    const byIssue = {};
    tickets.forEach(t=>{
      byBranch[t.branch] = (byBranch[t.branch]||0)+1;
      const type = classifyIssue(t.issue);
      byIssue[type] = (byIssue[type]||0)+1;
    });

    const branchLabels = Object.keys(byBranch);
    const branchData = Object.values(byBranch);
    const issueLabels = Object.keys(byIssue);
    const issueData = Object.values(byIssue);

    // branchChart
    if(!branchChart){
      branchChart = new Chart(document.getElementById('branchChart'), {
        type:'bar',
        data:{labels:branchLabels,datasets:[{label:'Tickets',data:branchData,backgroundColor:'rgba(211,47,47,0.78)'}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
      });
    } else {
      branchChart.data.labels = branchLabels;
      branchChart.data.datasets[0].data = branchData;
      branchChart.update();
    }

    if(!issueChart){
      issueChart = new Chart(document.getElementById('issueChart'), {
        type:'pie',
        data:{labels:issueLabels,datasets:[{data:issueData}]},
        options:{responsive:true}
      });
    } else {
      issueChart.data.labels = issueLabels;
      issueChart.data.datasets[0].data = issueData;
      issueChart.update();
    }

    document.getElementById('topBranchLabel').textContent = branchLabels.length? branchLabels[0] : '';
    document.getElementById('topIssueLabel').textContent = issueLabels.length? issueLabels[0] : '';
  }

  function classifyIssue(text=''){
    const t = (text||'').toLowerCase();
    if(/cold|temperature|ice|frozen/.test(t)) return 'Cold Food';
    if(/late|delay|time/.test(t)) return 'Late Delivery';
    if(/wrong|incorrect|different/.test(t)) return 'Wrong Items';
    if(/missing|not included|lack|نقص|missing_items/.test(t)) return 'Missing Items';
    if(/quality|taste|bad|spoiled/.test(t)) return 'Food Quality';
    return 'Other';
  }

  // ===== Actions: Add / Edit / Close / Sample / Reset =====
  function openAddModal(){
    document.getElementById('modalTitle').textContent = 'Add Compensation Ticket';
    document.getElementById('editingId').value = '';
    document.getElementById('ticketForm').reset();
    const nowLocal = new Date().toISOString().slice(0,16);
    document.getElementById('f_orderDate').value = nowLocal;
    new bootstrap.Modal(document.getElementById('ticketModal')).show();
  }

  document.getElementById('ticketForm').addEventListener('submit', function(e){
    e.preventDefault();
    const id = document.getElementById('editingId').value;
    const payload = {
      orderId: document.getElementById('f_orderId').value.trim(),
      orderDate: document.getElementById('f_orderDate').value,
      branch: document.getElementById('f_branch').value,
      platform: document.getElementById('f_platform').value,
      issue: document.getElementById('f_issue').value.trim(),
      compensation: Number(document.getElementById('f_compensation').value||0),
      evidence: document.getElementById('f_noEvidence').checked ? 'None' : (document.getElementById('f_evidence').value.trim() || 'None'),
      status: 'Open'
    };
    if(!payload.orderId || !payload.orderDate || !payload.branch || !payload.platform || !payload.issue){
      showNotif('Fill required fields', 'error'); return;
    }
    if(id){
      const idx = tickets.findIndex(t=>t.id===id);
      if(idx>-1){ tickets[idx] = {...tickets[idx], ...payload}; showNotif('Ticket updated','success'); }
    } else {
      const newTicket = {id:Date.now().toString(), ...payload};
      tickets.unshift(newTicket); showNotif('Ticket added','success');
    }
    save(); renderAll();
    bootstrap.Modal.getInstance(document.getElementById('ticketModal')).hide();
  });

  function editTicket(id){
    const t = tickets.find(x=>x.id===id); if(!t) return;
    document.getElementById('editingId').value = t.id;
    document.getElementById('f_orderId').value = t.orderId || '';
    document.getElementById('f_orderDate').value = t.orderDate || '';
    document.getElementById('f_branch').value = t.branch || '';
    document.getElementById('f_platform').value = t.platform || '';
    document.getElementById('f_issue').value = t.issue || '';
    document.getElementById('f_compensation').value = t.compensation || 0;
    document.getElementById('f_evidence').value = t.evidence && t.evidence!=='None' ? t.evidence : '';
    document.getElementById('f_noEvidence').checked = t.evidence==='None';
    autogrow(document.getElementById('f_issue'));
    new bootstrap.Modal(document.getElementById('ticketModal')).show();
  }

  function closeTicket(id){
    const t = tickets.find(x=>x.id===id); if(!t) return;
    t.status = 'Closed'; save(); renderAll(); showNotif('Ticket closed','success');
  }

  function addSample(){
    const sample = [
      { id: Date.now().toString()+'a', orderId:'NC'+Math.floor(Math.random()*900000+100000), orderDate:new Date().toISOString(), branch:'Crispy Chicken Khalidiya', platform:'Noon', issue:'Food was cold and delivery was late', compensation:25, evidence:'None', status:'Open'},
      { id: Date.now().toString()+'b', orderId:'CR'+Math.floor(Math.random()*900000+100000), orderDate:new Date().toISOString(), branch:'Crispy Chicken Muroor', platform:'Careem', issue:'Wrong order items received', compensation:45, evidence:'None', status:'Open'}
    ];
    tickets = sample.concat(tickets); save(); renderAll(); showNotif('Sample tickets added','success');
  }

  function resetAll(){
    if(!confirm('Reset all tickets?')) return;
    localStorage.removeItem('crispyTickets'); tickets=[]; renderAll(); showNotif('Data reset','success');
  }

  // ===== Communications =====
  function sendEmail(id){
    const t = tickets.find(x=>x.id===id); if(!t) return;
    const subject = `Compensation Ticket — Order ${t.orderId}`;
    const body = `Order ID: ${t.orderId}\nDate: ${formatDateISO(t.orderDate)}\nBranch: ${t.branch}\nPlatform: ${t.platform}\nIssue: ${t.issue}\nCompensation: AED ${Number(t.compensation||0).toFixed(2)}\nStatus: ${t.status}`;
    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    t.status = 'Sent'; save(); renderAll(); showNotif('Email client opened','success');
  }

  function sendWhatsApp(id){
    const t = tickets.find(x=>x.id===id); if(!t) return;
    const bn = branchWhats[t.branch] || '';
    const msg = `Compensation Ticket\nOrder: ${t.orderId}\nBranch: ${t.branch}\nIssue: ${t.issue}\nCompensation: AED ${Number(t.compensation||0).toFixed(2)}`;
    if(bn){
      window.open(`https://wa.me/${bn}?text=${encodeURIComponent(msg)}`, '_blank');
    } else {
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    }
    t.status = 'Sent'; save(); renderAll(); showNotif('WhatsApp opened','success');
  }

  function copyTicket(id){
    const t = tickets.find(x=>x.id===id); if(!t) return;
    const txt = `Order ID: ${t.orderId}\nDate: ${formatDateISO(t.orderDate)}\nBranch: ${t.branch}\nPlatform: ${t.platform}\nIssue: ${t.issue}\nComp: AED ${Number(t.compensation||0).toFixed(2)}`;
    navigator.clipboard.writeText(txt).then(()=>showNotif('Copied to clipboard','success'), ()=>showNotif('Copy failed','error'));
  }

  // ===== Issue modal =====
  function openIssueModal(id){
    const t = tickets.find(x=>x.id===id); if(!t) return;
    document.getElementById('issueText').textContent = t.issue;
    new bootstrap.Modal(document.getElementById('issueModal')).show();
  }

  // ===== Dock logic (toggle + draggable) =====
  dockToggle.addEventListener('click', ()=>{
    dockPanel.classList.toggle('show');
  });

  // Draggable dock
  (function(){
    let dragging=false, offsetX=0, offsetY=0;
    dock.addEventListener('mousedown', (e)=>{
      if(e.target.id=== 'dockToggle' || e.target.closest('.dock-panel')) return;
      dragging=true;
      const rect = dock.getBoundingClientRect();
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;
      dock.style.transition='none';
      document.body.style.userSelect='none';
    });
    document.addEventListener('mousemove', (e)=>{
      if(!dragging) return;
      dock.style.left = (e.clientX - offsetX) + 'px';
      dock.style.top = (e.clientY - offsetY) + 'px';
      dock.style.right = 'auto'; dock.style.bottom = 'auto';
    });
    document.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect='auto'; dock.style.transition=''; });
  })();

  // ===== Auto-grow textarea =====
  function autogrow(el){ if(!el) return; el.style.height='auto'; el.style.height = (el.scrollHeight) + 'px'; }
  document.addEventListener('input', (e)=>{ if(e.target && e.target.matches('textarea.autogrow')) autogrow(e.target); });

  // ===== Search & filters =====
  searchInput.addEventListener('input', debounce(()=>renderTickets(),200));
  filterBranch.addEventListener('change', ()=>renderTickets());
  filterPlatform.addEventListener('change', ()=>renderTickets());

  function debounce(fn,ms=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

  // ===== Export Excel =====
  function exportExcel(){
    const wb = XLSX.utils.book_new();
    const data = tickets.map(t=>({
      OrderID: t.orderId,
      OrderDate: t.orderDate,
      Branch: t.branch,
      Platform: t.platform,
      Issue: t.issue,
      Evidence: t.evidence,
      Compensation: t.compensation,
      Status: t.status,
      DateCreated: t.dateCreated||''
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "Tickets");
    XLSX.writeFile(wb, `compensation_tickets_${new Date().toISOString().slice(0,10)}.xlsx`);
  }

  // ===== Export PDF (single section) =====
  async function exportPDF(){
    try{
      // temporarily hide dock
      dockPanel.classList.remove('show');
      dockToggle.style.display='none';
      await sleep(150);
      const el = document.querySelector('#ticketsContainer');
      const canvas = await html2canvas(el, {scale:1.5, useCORS:true});
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','mm','a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgProps = pdf.getImageProperties(imgData);
      const imgWidth = pageWidth - 20;
      const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
      pdf.addImage(imgData,'PNG',10,10,imgWidth, imgHeight);
      pdf.save(`tickets_${new Date().toISOString().slice(0,10)}.pdf`);
    } catch(err){ console.error(err); showNotif('PDF export failed','error'); }
    finally{ dockToggle.style.display='flex'; }
  }

  // ===== Dashboard summary PDF (charts + table) =====
  async function exportDashboardSummary(){
    try{
      dockPanel.classList.remove('show'); dockToggle.style.display='none';
      await sleep(200);
      const reportsEl = document.getElementById('reports');
      const ticketsEl = document.getElementById('ticketsContainer');
      // render each to canvas
      const canvas1 = await html2canvas(reportsEl, {scale:1.5, useCORS:true});
      const canvas2 = await html2canvas(ticketsEl, {scale:1.5, useCORS:true});
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','mm','a4');
      const pageW = pdf.internal.pageSize.getWidth();
      // first page: charts
      const img1 = canvas1.toDataURL('image/png');
      const img1Props = pdf.getImageProperties(img1);
      const img1W = pageW - 20;
      const img1H = img1Props.height * img1W / img1Props.width;
      pdf.addImage(img1,'PNG',10,10,img1W,img1H);
      // next page: tickets table
      pdf.addPage();
      const img2 = canvas2.toDataURL('image/png');
      const img2Props = pdf.getImageProperties(img2);
      const img2W = pageW - 20;
      const img2H = img2Props.height * img2W / img2Props.width;
      pdf.addImage(img2,'PNG',10,10,img2W,img2H);
      pdf.save(`dashboard_summary_${new Date().toISOString().slice(0,10)}.pdf`);
    } catch(err){ console.error(err); showNotif('Dashboard PDF failed','error'); }
    finally{ dockToggle.style.display='flex'; }
  }

  // ===== Usability heatmap & export log =====
  function initHeatmap(){
    heatmapInstance = h337.create({container: heatmapContainer, radius:35, maxOpacity:.6, minOpacity:.05, blur:.75});
    document.addEventListener('click', (e)=>recordInteraction(e));
    document.addEventListener('mousemove', throttle((e)=>recordMouseMove(e), 120));
  }
  function toggleHeatmap(){
    heatmapVisible = !heatmapVisible;
    heatmapContainer.style.display = heatmapVisible ? 'block' : 'none';
    document.getElementById('heatmapToggleBtn').classList.toggle('active', heatmapVisible);
  }
  function recordInteraction(e){
    const el = e.target;
    const entry = { t: Date.now(), type:'click', x:e.clientX, y:e.clientY, tag:el.tagName, id:el.id||null, cls:el.className||null };
    interactions.push(entry);
    if(interactions.length>500) interactions.shift();
    if(heatmapInstance) heatmapInstance.addData({x:e.clientX,y:e.clientY,value:1});
  }
  function recordMouseMove(e){
    if(!heatmapVisible) return;
    if(heatmapInstance) heatmapInstance.addData({x:e.clientX,y:e.clientY,value:.15});
  }
  function exportUsabilityLog(){
    const data = JSON.stringify({at:new Date().toISOString(), interactions}, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=`usability_log_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
    showNotif('Usability log exported','success');
  }

  // ===== Helpers =====
  function sleep(ms){ return new Promise(res=>setTimeout(res,ms)); }
  function escapeHtml(s=''){ return (s+'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
  function throttle(fn,ms){ let last=0; return function(...a){ const now=Date.now(); if(now-last>ms){ last=now; fn(...a); } }; }

  // ===== Export all tickets as PDF (single) - kept as alias =====
  function exportPDF_simple(){ exportPDF(); }

  // ===== Usability: Sleep for UI =====

  // ===== Misc: classify etc done earlier =====

  // ===== Init listeners for search, filters =====
  function setupListeners(){
    // search & filters handled earlier
    // dock close on outside click
    document.addEventListener('click', (e)=>{
      if(!dock.contains(e.target) && dockPanel.classList.contains('show')){
        dockPanel.classList.remove('show');
      }
    });
    // auto grow init
    document.querySelectorAll('textarea.autogrow').forEach(t=>autogrow(t));
    // ensure form branch selects populated
    populateBranchFilters();
  }

  // ===== Replace old functions used earlier (for completeness) =====
  function exportPDF(){ exportPDF_simple(); } // fallback

  // ===== Seed: ensure sample if empty =====
  // (already called on DOMContentLoaded)

  // ===== End of script =====
  </script>
</body>
</html>
